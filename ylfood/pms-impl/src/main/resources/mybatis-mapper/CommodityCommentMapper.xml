<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.spfood.pms.intf.domain.CommodityComment" >
  <resultMap id="BaseResultMap" type="com.spfood.pms.intf.domain.CommodityComment" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="comment_usercode" property="commentUsercode" jdbcType="VARCHAR" />
    <result column="commodity_code" property="commodityCode" jdbcType="VARCHAR" />
    <result column="category_code" property="categoryCode" jdbcType="VARCHAR" />
    <result column="comment_content" property="commentContent" jdbcType="VARCHAR" />
    <result column="comment_grade" property="commentGrade" jdbcType="INTEGER" />
    <result column="order_no" property="orderNo" jdbcType="VARCHAR" />
    <result column="comment_time" property="commentTime" jdbcType="TIMESTAMP" />
    <result column="comment_status" property="commentStatus" jdbcType="INTEGER" />
    <result column="comment_type_code" property="commentTypeCode" jdbcType="INTEGER" />
    <result column="express_good_count" property="expressGoodCount" jdbcType="INTEGER" />
    <result column="express_mid_count" property="expressMidCount" jdbcType="INTEGER" />
    <result column="express_bad_count" property="expressBadCount" jdbcType="INTEGER" />
    <result column="package_good_count" property="packageGoodCount" jdbcType="INTEGER" />
    <result column="package_mid_count" property="packageMidCount" jdbcType="INTEGER" />
    <result column="package_bad_count" property="packageBadCount" jdbcType="INTEGER" />
    <result column="commodity_good_count" property="commodityGoodCount" jdbcType="INTEGER" />
    <result column="commodity_mid_count" property="commodityMidCount" jdbcType="INTEGER" />
    <result column="commodity_bad_count" property="commodityBadCount" jdbcType="INTEGER" />
    <result column="express_grade" property="expressGrade" jdbcType="INTEGER" />
    <result column="package_grade" property="packageGrade" jdbcType="INTEGER" />
    <result column="commodity_grade" property="commodityGrade" jdbcType="INTEGER" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    id, comment_usercode, commodity_code, category_code, comment_content, comment_grade, 
    order_no, comment_time, comment_status, comment_type_code
  </sql>
  <sql id="Base_Where_Case" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <where >
      <if test="id != null" >
         AND id = #{id,jdbcType=BIGINT}
      </if>
      <if test="commentUsercode != null" >
         AND comment_usercode = #{commentUsercode,jdbcType=VARCHAR}
      </if>
      <if test="commodityCode != null" >
         AND commodity_code = #{commodityCode,jdbcType=VARCHAR}
      </if>
      <if test="categoryCode != null" >
         AND category_code = #{categoryCode,jdbcType=VARCHAR}
      </if>
      <if test="commentContent != null" >
         AND comment_content = #{commentContent,jdbcType=VARCHAR}
      </if>
      <if test="commentGrade != null" >
         AND comment_grade = #{commentGrade,jdbcType=INTEGER}
      </if>
      <if test="orderNo != null" >
         AND order_no = #{orderNo,jdbcType=VARCHAR}
      </if>
      <if test="commentTime != null" >
         AND comment_time = #{commentTime,jdbcType=TIMESTAMP}
      </if>
      <if test="commentStatus != null" >
         AND comment_status = #{commentStatus,jdbcType=INTEGER}
      </if>
      <if test="commentTypeCode != null" >
         AND comment_type_code = #{commentTypeCode,jdbcType=INTEGER}
      </if>
    </where>
  </sql>
  <select id="selectCount" resultType="java.lang.Long" parameterType="com.spfood.pms.intf.domain.CommodityComment" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select count( id)
     from pms_commodity_comment
    <include refid="Base_Where_Case" />
  </select>
  <select id="select" resultMap="BaseResultMap" parameterType="com.spfood.pms.intf.domain.CommodityComment" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
     from pms_commodity_comment
    <include refid="Base_Where_Case" />
    <if test="limit > 0" >
       limit #{offset},#{limit} 
    </if>
  </select>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from pms_commodity_comment
    where id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from pms_commodity_comment
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.spfood.pms.intf.domain.CommodityComment" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into pms_commodity_comment (id, comment_usercode, commodity_code, 
      category_code, comment_content, comment_grade, 
      order_no, comment_time, comment_status, 
      comment_type_code)
    values (#{id,jdbcType=BIGINT}, #{commentUsercode,jdbcType=VARCHAR}, #{commodityCode,jdbcType=VARCHAR}, 
      #{categoryCode,jdbcType=VARCHAR}, #{commentContent,jdbcType=VARCHAR}, #{commentGrade,jdbcType=INTEGER}, 
      #{orderNo,jdbcType=VARCHAR}, #{commentTime,jdbcType=TIMESTAMP}, #{commentStatus,jdbcType=INTEGER}, 
      #{commentTypeCode,jdbcType=INTEGER})
  </insert>
  <insert id="insertSelective" parameterType="com.spfood.pms.intf.domain.CommodityComment" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into pms_commodity_comment
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="commentUsercode != null" >
        comment_usercode,
      </if>
      <if test="commodityCode != null" >
        commodity_code,
      </if>
      <if test="categoryCode != null" >
        category_code,
      </if>
      <if test="commentContent != null" >
        comment_content,
      </if>
      <if test="commentGrade != null" >
        comment_grade,
      </if>
      <if test="orderNo != null" >
        order_no,
      </if>
      <if test="commentTime != null" >
        comment_time,
      </if>
      <if test="commentStatus != null" >
        comment_status,
      </if>
      <if test="commentTypeCode != null" >
        comment_type_code,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=BIGINT},
      </if>
      <if test="commentUsercode != null" >
        #{commentUsercode,jdbcType=VARCHAR},
      </if>
      <if test="commodityCode != null" >
        #{commodityCode,jdbcType=VARCHAR},
      </if>
      <if test="categoryCode != null" >
        #{categoryCode,jdbcType=VARCHAR},
      </if>
      <if test="commentContent != null" >
        #{commentContent,jdbcType=VARCHAR},
      </if>
      <if test="commentGrade != null" >
        #{commentGrade,jdbcType=INTEGER},
      </if>
      <if test="orderNo != null" >
        #{orderNo,jdbcType=VARCHAR},
      </if>
      <if test="commentTime != null" >
        #{commentTime,jdbcType=TIMESTAMP},
      </if>
      <if test="commentStatus != null" >
        #{commentStatus,jdbcType=INTEGER},
      </if>
      <if test="commentTypeCode != null" >
        #{commentTypeCode,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.spfood.pms.intf.domain.CommodityComment" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update pms_commodity_comment
    <set >
      <if test="commentUsercode != null" >
        comment_usercode = #{commentUsercode,jdbcType=VARCHAR},
      </if>
      <if test="commodityCode != null" >
        commodity_code = #{commodityCode,jdbcType=VARCHAR},
      </if>
      <if test="categoryCode != null" >
        category_code = #{categoryCode,jdbcType=VARCHAR},
      </if>
      <if test="commentContent != null" >
        comment_content = #{commentContent,jdbcType=VARCHAR},
      </if>
      <if test="commentGrade != null" >
        comment_grade = #{commentGrade,jdbcType=INTEGER},
      </if>
      <if test="orderNo != null" >
        order_no = #{orderNo,jdbcType=VARCHAR},
      </if>
      <if test="commentTime != null" >
        comment_time = #{commentTime,jdbcType=TIMESTAMP},
      </if>
      <if test="commentStatus != null" >
        comment_status = #{commentStatus,jdbcType=INTEGER},
      </if>
      <if test="commentTypeCode != null" >
        comment_type_code = #{commentTypeCode,jdbcType=INTEGER},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.spfood.pms.intf.domain.CommodityComment" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update pms_commodity_comment
    set comment_usercode = #{commentUsercode,jdbcType=VARCHAR},
      commodity_code = #{commodityCode,jdbcType=VARCHAR},
      category_code = #{categoryCode,jdbcType=VARCHAR},
      comment_content = #{commentContent,jdbcType=VARCHAR},
      comment_grade = #{commentGrade,jdbcType=INTEGER},
      order_no = #{orderNo,jdbcType=VARCHAR},
      comment_time = #{commentTime,jdbcType=TIMESTAMP},
      comment_status = #{commentStatus,jdbcType=INTEGER},
      comment_type_code = #{commentTypeCode,jdbcType=INTEGER}
    where id = #{id,jdbcType=BIGINT}
  </update>
  <select id="selectPageInCommodityComment" resultMap="BaseResultMap" parameterType="com.spfood.pms.intf.domain.CommodityComment" >
	SELECT id FROM(
		SELECT  c.id, c.comment_usercode, c.commodity_code, c.category_code, c.comment_content,  c.order_no, c.comment_time,
							 MAX(CASE WHEN c.comment_type_code = 1 THEN  c.comment_grade  ELSE 0 END) as express_grade
							,MAX(CASE WHEN c.comment_type_code = 2 THEN  c.comment_grade  ELSE 0 END) as package_grade
							,MAX(CASE WHEN c.comment_type_code = 3 THEN  c.comment_grade  ELSE 0 END) as commodity_grade
		FROM   pms_commodity_comment c  
		WHERE 1=1
			AND commodity_code = #{commodityCode,jdbcType=VARCHAR}
			
			<!-- 用户昵称 -->
	        <if test="commentUsercodeList != null" >
	       	 AND comment_usercode in 
				<foreach item="item" index="index" collection="commentUsercodeList" open="("
					separator="," close=")">
					#{item}
				</foreach>
	        </if>
			<!-- 订单编号 -->
			<if test="orderNo != null and orderNo != ''" >
					AND order_no like '%' #{orderNo} '%'
			</if>
			<!-- 评价关键字 -->
			<if test="commentContent != null  and commentContent != ''" >
					AND comment_content like '%' #{commentContent} '%'
			</if>
			<!-- 评价时间 -->
			<if test="commodityCommentDateSt != null and commodityCommentDateEd != null" >
					AND comment_time BETWEEN #{commodityCommentDateSt} AND #{commodityCommentDateEd}
			</if>
		GROUP BY commodity_code,comment_usercode,order_no
		ORDER BY comment_time DESC
	) AS page
  </select>
  
    <select id="selectPageInCommodityCommentDetail" resultMap="BaseResultMap" parameterType="com.spfood.pms.intf.domain.CommodityComment">
				SELECT
					id,
					comment_usercode,
					commodity_code,
					category_code,
					comment_content,
					order_no,
					comment_time,
					express_grade,
					package_grade,
					commodity_grade,
					comment_status
				FROM
					(
						SELECT
							c.id,
							c.comment_usercode,
							c.commodity_code,
							c.category_code,
							c.comment_content,
							c.order_no,
							c.comment_time,
							c.comment_status,
							MAX(
								CASE
								WHEN c.comment_type_code = 1 THEN
									c.comment_grade
								ELSE
									0
								END
							) AS express_grade,
							MAX(
								CASE
								WHEN c.comment_type_code = 2 THEN
									c.comment_grade
								ELSE
									0
								END
							) AS package_grade,
							MAX(
								CASE
								WHEN c.comment_type_code = 3 THEN
									c.comment_grade
								ELSE
									0
								END
							) AS commodity_grade
						FROM
							pms_commodity_comment c
						GROUP BY
							commodity_code,
							comment_usercode,
							order_no
						ORDER BY
							commodity_grade DESC
					) AS t
				WHERE
					1 = 1
		        <if test="idList != null" >
		        AND t.id in 
					<foreach item="item" index="index" collection="idList" open="("
						separator="," close=")">
						#{item}
					</foreach>
		        </if>
					<if test="orderBy == null or 
					orderBy == ''" >
					ORDER BY commodity_grade DESC,express_grade DESC,package_grade DESC
					</if>
			
					<if test="orderBy == 13" >
					ORDER BY express_grade ASC,package_grade ASC,commodity_grade ASC
					</if>
					
					<if test="orderBy == 14" >
					ORDER BY express_grade DESC,package_grade DESC,commodity_grade DESC
					</if>
					
					<if test="orderBy == 15" >
					ORDER BY package_grade ASC,express_grade ASC,commodity_grade ASC
					</if>
					
					<if test="orderBy == 16" >
					ORDER BY package_grade DESC,express_grade DESC,commodity_grade DESC
					</if>
					
					<if test="orderBy == 17" >
					ORDER BY commodity_grade ASC,express_grade ASC,package_grade ASC
					</if>
					
					<if test="orderBy == 18" >
					ORDER BY commodity_grade DESC,express_grade DESC,package_grade DESC
					</if>
	</select>
  <select id="selectCommodityCommentCount" resultMap="BaseResultMap" parameterType="com.spfood.pms.intf.domain.CommodityComment" >
		SELECT
			IF(SUM(commodity_good) IS NULL,0,SUM(commodity_good)) AS commodity_good_count,
			IF(SUM(commodity_mid) IS NULL,0,SUM(commodity_mid)) AS commodity_mid_count,
			IF(SUM(commodity_bad) IS NULL,0,SUM(commodity_bad)) AS commodity_bad_count
		FROM
			(
				SELECT
					id,
					CASE WHEN comment_grade IN (4, 5) THEN COUNT(*) ELSE 0 END AS commodity_good,
					CASE WHEN comment_grade IN (2, 3) THEN COUNT(*) ELSE 0 END AS commodity_mid,
					CASE WHEN comment_grade = 1 THEN COUNT(*) ELSE 0 END AS commodity_bad
				FROM
				(
					SELECT
						a.id, a.comment_grade
					FROM
						pms_commodity_comment AS a
					WHERE
						a.commodity_code = #{commodityCode,jdbcType=VARCHAR}
						AND a.comment_type_code = 3
						<!-- 用户昵称 -->
				        <if test="commentUsercodeList != null" >
				       	 AND comment_usercode in 
							<foreach item="item" index="index" collection="commentUsercodeList" open="("
								separator="," close=")">
								#{item}
							</foreach>
				        </if>
						<!-- 订单编号 -->
						<if test="orderNo != null and orderNo != ''" >
								AND order_no like '%' #{orderNo} '%'
						</if>
						<!-- 评价关键字 -->
						<if test="commentContent != null  and commentContent != ''" >
								AND comment_content like '%' #{commentContent} '%'
						</if>
						<!-- 评价时间 -->
						<if test="commodityCommentDateSt != null and commodityCommentDateEd != null" >
								AND comment_time BETWEEN #{commodityCommentDateSt} AND #{commodityCommentDateEd}
						</if>
					GROUP BY
						a.id
				) AS b
		GROUP BY
			id
			) AS c
  </select>
  <update id="updateCommodityCommentStatus" parameterType="com.spfood.pms.intf.domain.CommodityComment" >
		UPDATE pms_commodity_comment AS a
		SET a.comment_status = #{commentStatus,jdbcType=VARCHAR}
		WHERE
			a.comment_usercode = #{commentUsercode,jdbcType=VARCHAR}
		AND a.commodity_code = #{commodityCode,jdbcType=VARCHAR}
		AND a.order_no = #{orderNo,jdbcType=VARCHAR}
  </update>
</mapper>