<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.spfood.pms.search.intf.domain.criteria.CommodityAndComment" >
  <resultMap id="BaseResultMap" type="com.spfood.pms.search.intf.domain.criteria.CommodityAndComment" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="commodity_code" property="commodityCode" jdbcType="VARCHAR" />
    <result column="commodity_gs1_code" property="commodityGs1Code" jdbcType="VARCHAR" />
    <result column="category_code" property="category.categoryCode" jdbcType="VARCHAR" />
    <result column="product_code" property="product.productCode" jdbcType="VARCHAR" />
    <result column="commodity_name" property="commodityName" jdbcType="VARCHAR" />
    <result column="commodity_show_name" property="commodityShowName" jdbcType="VARCHAR" />
    <result column="commodity_city" property="commodityCity" jdbcType="VARCHAR" />
    <result column="commodity_price" property="commodityPrice" jdbcType="REAL" />
    <result column="commodity_sales_price" property="commoditySalesPrice" jdbcType="REAL" />
    <result column="image_url" property="imageUrl" jdbcType="VARCHAR" />
    <result column="sales_amount" property="salesAmount" jdbcType="INTEGER" />
    <result column="commodity_product_quantity" property="commodityProductQuantity" jdbcType="INTEGER" />
    <result column="default_flag" property="defaultFlag" jdbcType="INTEGER" />
    <result column="commodity_weight_unit" property="commodityWeightUnit" jdbcType="VARCHAR" />
    <result column="commodity_show_place" property="commodityShowPlace" jdbcType="VARCHAR" />
    <result column="commodity_comment" property="commodityComment" jdbcType="VARCHAR" />
    <result column="commodity_weight" property="commodityWeight" jdbcType="DOUBLE" />
    <result column="commodity_quantity" property="commodityQuantity" jdbcType="INTEGER" />
    <result column="commodity_status" property="commodityStatus" jdbcType="INTEGER" />
    <result column="product_temperature_zone_name" property="productTemperatureZoneName" jdbcType="VARCHAR" />
    <result column="product_temperature_zone_code" property="productTemperatureZoneCode" jdbcType="VARCHAR" />
    <result column="create_date" property="createDate" jdbcType="TIMESTAMP" />
    <result column="create_user" property="createUser" jdbcType="VARCHAR" />
    <result column="last_update_date" property="lastUpdateDate" jdbcType="TIMESTAMP" />
    <result column="last_update_user" property="lastUpdateUser" jdbcType="VARCHAR" />
    <result column="category_name" property="category.categoryName" jdbcType="VARCHAR" />
    <result column="product_specification_value" property="product.productSpecificationValue" jdbcType="FLOAT" />
    <result column="product_specification_unit_first" property="product.productSpecificationUnitFirst" jdbcType="VARCHAR" />
    <result column="product_specification_unit_second" property="product.productSpecificationUnitSecond" jdbcType="VARCHAR" />
    <result column="commodity_good_count" property="goodComment" jdbcType="INTEGER" />
    <result column="commodity_mid_count" property="mediumComment" jdbcType="INTEGER"/>
    <result column="commodity_bad_count" property="badComment" jdbcType="INTEGER"/>
    
    <collection property="commodityPropertys" ofType="com.spfood.pms.search.intf.domain.CommodityProperty">
        <id column="cid" property="id" jdbcType="BIGINT" />
	    <result column="commdity_code" property="commodityCode" jdbcType="VARCHAR" />
	    <result column="commdity_property_name" property="commdityPropertyName" jdbcType="VARCHAR" />
	    <result column="commdity_property_value" property="commdityPropertyValue" jdbcType="VARCHAR" />
    </collection>
    
  </resultMap>
  
  <resultMap id="commodity_picture" type="com.spfood.pms.search.intf.domain.criteria.CommodityAndComment" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="commodity_code" property="commodityCode" jdbcType="VARCHAR" />
    <result column="commodity_gs1_code" property="commodityGs1Code" jdbcType="VARCHAR" />
    <result column="category_code" property="category.categoryCode" jdbcType="VARCHAR" />
    <result column="product_code" property="product.productCode" jdbcType="VARCHAR" />
    <result column="category_name" property="category.categoryName" jdbcType="VARCHAR" />
    <result column="commodity_name" property="commodityName" jdbcType="VARCHAR" />
    <result column="commodity_show_name" property="commodityShowName" jdbcType="VARCHAR" />
    <result column="commodity_city" property="commodityCity" jdbcType="VARCHAR" />
    <result column="commodity_price" property="commodityPrice" jdbcType="REAL" />
    <result column="commodity_sales_price" property="commoditySalesPrice" jdbcType="REAL" />
    <result column="sales_amount" property="salesAmount" jdbcType="INTEGER" />
    <result column="commodity_product_quantity" property="commodityProductQuantity" jdbcType="INTEGER" />
    <result column="default_flag" property="defaultFlag" jdbcType="INTEGER" />
    <result column="commodity_weight_unit" property="commodityWeightUnit" jdbcType="VARCHAR" />
    <result column="commodity_show_place" property="commodityShowPlace" jdbcType="VARCHAR" />
    <result column="commodity_comment" property="commodityComment" jdbcType="VARCHAR" />
    <result column="commodity_weight" property="commodityWeight" jdbcType="DOUBLE" />
    <result column="commodity_quantity" property="commodityQuantity" jdbcType="INTEGER" />
    <result column="commodity_status" property="commodityStatus" jdbcType="INTEGER" />
    <result column="commodity_good_count" property="goodComment" jdbcType="INTEGER" />
    <result column="commodity_mid_count" property="mediumComment" jdbcType="INTEGER"/>
    <result column="commodity_bad_count" property="badComment" jdbcType="INTEGER"/>
    
    <collection property="commodityPictures" ofType="com.spfood.pms.search.intf.domain.CommodityPicture">
        <id column="pid" property="id" jdbcType="BIGINT" />
	    <result column="picture_show_position" property="pictureShowPosition" jdbcType="VARCHAR" />
	    <result column="picture_show_order" property="pictureShowOrder" jdbcType="VARCHAR" />
	    <result column="picture_url" property="pictureUrl" jdbcType="VARCHAR" />
    </collection>
    
  </resultMap>
  
  
  <select id="selecCommodityACommenttByCodelist" resultMap="BaseResultMap" parameterType="java.util.List" >
			SELECT
				pms_commodity.id,
				pms_commodity.commodity_code,
				pms_commodity.category_code,
				pms_commodity.commodity_name,
				pms_commodity.commodity_status,
				pms_commodity.product_code,
				pms_commodity.commodity_comment,
				pms_commodity.commodity_price,
				pms_commodity.commodity_sales_price,
			     pms_commodity.sales_amount,
				pms_commodity.commodity_weight_unit,
				pms_commodity.commodity_product_quantity,
				pms_commodity.commodity_gs1_code,
				pms_commodity.default_flag,
				pms_commodity.commodity_weight,
				pms_commodity.commodity_quantity,
				pms_commodity.commodity_show_place,
				pms_commodity.commodity_city,
				pms_commodity.product_temperature_zone_code,
				pms_commodity.product_temperature_zone_name,
				pms_commodity_property.id AS cid,
				pms_commodity_property.commdity_property_name,
				pms_commodity_property.commdity_property_value,
				pms_commodity_picture.picture_url AS image_url,
				pms_product_category.category_name,
				d.commodity_good_count,
				d.commodity_mid_count,
				d.commodity_bad_count
			FROM
				pms_commodity
			LEFT JOIN pms_commodity_picture ON pms_commodity.commodity_code = pms_commodity_picture.commodity_code
			LEFT JOIN pms_product_category ON pms_commodity.category_code = pms_product_category.category_code
			LEFT JOIN pms_commodity_property ON pms_commodity_property.commdity_code = pms_commodity.commodity_code
			LEFT JOIN 
								(SELECT
									commodity_code,
									IF(SUM(commodity_good) IS NULL,0,SUM(commodity_good)) AS commodity_good_count,
									IF(SUM(commodity_mid) IS NULL,0,SUM(commodity_mid)) AS commodity_mid_count,
									IF(SUM(commodity_bad) IS NULL,0,SUM(commodity_bad)) AS commodity_bad_count
								FROM
									(
										SELECT
											id,commodity_code,
											CASE WHEN comment_grade IN (4, 5) THEN COUNT(*) ELSE 0 END AS commodity_good,
											CASE WHEN comment_grade IN (2, 3) THEN COUNT(*) ELSE 0 END AS commodity_mid,
											CASE WHEN comment_grade = 1 THEN COUNT(*) ELSE 0 END AS commodity_bad
										FROM
										(
											SELECT
												a.id, a.comment_grade,a.commodity_code
											FROM
												pms_commodity_comment AS a
											WHERE
												 a.comment_type_code = 3
											GROUP BY
												a.id,a.commodity_code
											ORDER BY a.commodity_code ASC
										) AS b
								GROUP BY
									id,commodity_code
									) AS c
								GROUP BY
									commodity_code) AS d
			 ON d.commodity_code = pms_commodity.commodity_code
			WHERE
				pms_commodity_picture.picture_show_order = 0
			AND pms_commodity_picture.picture_show_position = 0
    	  <if test="list != null and list.size() > 0" >
				and pms_commodity.commodity_code  in (
    		<foreach item="item" index="index" collection="list"  separator=",">
				#{item}
			</foreach>
			 )
		  </if>
  </select>
  
  
  
  <select id="selectByPage" resultMap="BaseResultMap" parameterType="com.spfood.pms.search.intf.domain.criteria.CommodityAndComment" >
		select id from( 
		
		select pms_commodity.id as id
			from 		pms_commodity 
			left join   pms_product_category on pms_commodity.category_code = pms_product_category.category_code
			where 1=1 
				<if test="commodityStatus != null" >
		         	AND pms_commodity.commodity_status = #{commodityStatus}
		        </if>
		        <if test="commodityShowPlace != null" >
		            AND pms_commodity.commodity_show_place = #{commodityShowPlace}
		        </if>
				<if test="category != null and category.categoryCode != null" >
		            AND pms_commodity.category_code like #{category.categoryCode,jdbcType=VARCHAR} '%'
		        </if>
		        <if test="keywords != null" >
			      	<foreach item="item" index="index" collection="keywords" >
					 	and(
						  pms_commodity.commodity_name like '%' #{item,jdbcType=VARCHAR} '%'
						  or
						  pms_commodity.search_property like '%:' #{item,jdbcType=VARCHAR} '%'
						  or
						  pms_product_category.category_name like '%' #{item,jdbcType=VARCHAR} '%'
						  or
						  pms_product_category.category_another_name like '%' #{item,jdbcType=VARCHAR} '%'
						  ) 
					</foreach>
		        </if>
		        <if test="commodityPropertys != null" >
				      <foreach item="item" index="index" collection="commodityPropertys">
						 and pms_commodity.search_property like #{item.commdityPropertyName,jdbcType=VARCHAR}
					 </foreach>
		        </if>
	      GROUP BY pms_commodity.id
				<if test="orderBys == null" >
				    order by id desc
				</if>
			 	<if test="orderBys == 0" >
			        order by pms_commodity.sales_amount desc,pms_commodity.commodity_sales_price asc
		        </if>
		      	<if test="orderBys == 1" >
			     	order by pms_commodity.commodity_sales_price asc
		      	</if>
		      	<if test="orderBys == 2" >
			     	order by pms_commodity.commodity_sales_price desc
		      	</if>
		      	<if test="orderBys == 3" >
			    	order by pms_commodity.sales_amount asc
		      	</if>
		      	<if test="orderBys == 4" >
			     	order by pms_commodity.sales_amount desc
		      	</if>
		      ) as tempCommodity
  </select>
  
  
  	<select id="selectListByIdsForComment" resultMap="commodity_picture" parameterType="java.util.List">
	 select		pms_commodity.id,
				pms_commodity.commodity_code,
    		  	pms_commodity.category_code,
				pms_commodity.commodity_name,
				pms_commodity.commodity_status,
				pms_commodity.product_code,
			    pms_commodity.commodity_comment,
			    pms_commodity.commodity_price,
			    pms_commodity.commodity_sales_price,
			     pms_commodity.sales_amount,
			    pms_commodity.commodity_weight_unit,
			    pms_commodity.commodity_product_quantity,
			    pms_commodity.commodity_gs1_code,
			    pms_commodity.commodity_weight,
			    pms_commodity.commodity_quantity,
			    pms_commodity.commodity_show_place,
			    pms_commodity.commodity_city,
			    pms_commodity.product_temperature_zone_code,
			    pms_commodity.product_temperature_zone_name,
				pms_commodity_picture.id as pid,
				pms_commodity_picture.picture_show_position,
				pms_commodity_picture.picture_show_order,
				pms_commodity_picture.picture_url,
				d.commodity_good_count,
				d.commodity_mid_count,
				d.commodity_bad_count
		from  pms_commodity 
		left join  pms_commodity_picture on pms_commodity_picture.commodity_code = pms_commodity.commodity_code
		LEFT JOIN 
				(SELECT
					commodity_code,
					IF(SUM(commodity_good) IS NULL,0,SUM(commodity_good)) AS commodity_good_count,
					IF(SUM(commodity_mid) IS NULL,0,SUM(commodity_mid)) AS commodity_mid_count,
					IF(SUM(commodity_bad) IS NULL,0,SUM(commodity_bad)) AS commodity_bad_count
				FROM
					(
						SELECT
							id,commodity_code,
							CASE WHEN comment_grade IN (4, 5) THEN COUNT(*) ELSE 0 END AS commodity_good,
							CASE WHEN comment_grade IN (2, 3) THEN COUNT(*) ELSE 0 END AS commodity_mid,
							CASE WHEN comment_grade = 1 THEN COUNT(*) ELSE 0 END AS commodity_bad
						FROM
						(
							SELECT
								a.id, a.comment_grade,a.commodity_code
							FROM
								pms_commodity_comment AS a
							WHERE
								 a.comment_type_code = 3
							GROUP BY
								a.id,a.commodity_code
							ORDER BY a.commodity_code ASC
						) AS b
				GROUP BY
					id,commodity_code
					) AS c
				GROUP BY
					commodity_code) AS d
		 ON d.commodity_code = pms_commodity.commodity_code
		where pms_commodity.id in
					<foreach item="item" index="index" collection="list" open="("
						separator="," close=")">
						#{item}
					</foreach> 
		order by  pms_commodity.id desc,
				  pms_commodity_picture.picture_show_position asc,
				  pms_commodity_picture.picture_show_order asc
	</select>
	
	  <select id="selectByPageApp" resultMap="BaseResultMap" parameterType="com.spfood.pms.search.intf.domain.criteria.CommodityAndComment" >
		select id from( 
		
		select pms_commodity.id as id
			from 		pms_commodity 
			left join   pms_product_category on pms_commodity.category_code = pms_product_category.category_code
			where 1=1 
				<if test="commodityStatus != null" >
		         	AND pms_commodity.commodity_status = #{commodityStatus}
		        </if>
		        <if test="commodityShowPlace != null" >
		            AND pms_commodity.commodity_show_place = #{commodityShowPlace}
		        </if>
				<if test="category != null and category.categoryCode != null" >
		            AND pms_commodity.category_code like #{category.categoryCode,jdbcType=VARCHAR}
		        </if>
	      GROUP BY pms_commodity.id
				    order by id desc
		      ) as tempCommodity
  </select>
</mapper>